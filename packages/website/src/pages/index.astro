---
import Layout from '../layouts/Layout.astro';
import Hero from '../components/Hero.astro';
import InstallCommand from '../components/InstallCommand.astro';
import CategoryFilter from '../components/CategoryFilter.astro';
import SkillGrid from '../components/SkillGrid.astro';
import ScientificPackages from '../components/ScientificPackages.astro';
import { skills } from '../data/skills';
import { categories } from '../data/categories';
import { downloadSingleSkill } from '../utils/downloader';
import { downloadSkillPack, filterSkillsForPack, skillPacks } from '../utils/packager';
---

<Layout title="Skills Controller - æ™ºèƒ½æŠ€èƒ½ç¼–æ’æ§åˆ¶å™¨">
  <Hero />

  <section id="features" class="features-section">
    <div class="container">
      <h2 class="section-title">æ ¸å¿ƒåŠŸèƒ½</h2>
      <div class="features-grid">
        <div class="feature-card">
          <div class="feature-icon">ğŸ¯</div>
          <h3 class="feature-title">æ™ºèƒ½è·¯ç”±</h3>
          <p class="feature-description">æ ¹æ®ä½ çš„æ„å›¾è‡ªåŠ¨æ¿€æ´»æœ€ç›¸å…³çš„æŠ€èƒ½ï¼Œæ— éœ€æ‰‹åŠ¨é€‰æ‹©</p>
        </div>
        <div class="feature-card">
          <div class="feature-icon">âš¡</div>
          <h3 class="feature-title">é›¶é…ç½®</h3>
          <p class="feature-description">å®‰è£…å³ç”¨ï¼Œè‡ªåŠ¨å‘ç°å’ŒåŠ è½½æŠ€èƒ½ï¼Œæ— éœ€ç¹çé…ç½®</p>
        </div>
        <div class="feature-card">
          <div class="feature-icon">ğŸ”„</div>
          <h3 class="feature-title">è‡ªåŠ¨ç®¡ç†</h3>
          <p class="feature-description">ç”¨å®Œå³åœï¼Œæ™ºèƒ½ç®¡ç†ä¸Šä¸‹æ–‡ç©ºé—´ï¼Œä¿æŒç³»ç»Ÿé«˜æ•ˆ</p>
        </div>
        <div class="feature-card">
          <div class="feature-icon">ğŸ“¦</div>
          <h3 class="feature-title">å¤šæºæ”¯æŒ</h3>
          <p class="feature-description">æ”¯æŒ Anthropicã€ClaudeKitã€ç¤¾åŒºç­‰å¤šç§æŠ€èƒ½æ¥æº</p>
        </div>
      </div>
    </div>
  </section>

  <InstallCommand />

  <!-- ç§‘å­¦ç ”ç©¶æŠ€èƒ½åŒ…å±•ç¤º -->
  <ScientificPackages />

  <div class="skills-container">
    <div class="container">
      <div class="skills-header">
        <h2 class="section-title">æŠ€èƒ½åº“</h2>
        <button class="btn btn-secondary download-pack-btn" id="download-pack">
          ğŸ“¦ ä¸‹è½½æŠ€èƒ½åŒ…
        </button>
      </div>
      <CategoryFilter categories={categories} selectedCategory={null} />
    </div>
    <SkillGrid skills={skills} selectedCategory={null} />
  </div>
</Layout>

<style>
  .features-section {
    padding: var(--spacing-xl) var(--spacing-md);
    background-color: var(--color-white);
  }

  .section-title {
    text-align: center;
    font-size: 2rem;
    font-weight: 600;
    margin-bottom: var(--spacing-lg);
  }

  .features-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
    gap: var(--spacing-md);
    max-width: 1200px;
    margin: 0 auto;
  }

  .feature-card {
    padding: var(--spacing-md);
    background: var(--color-bg-secondary);
    border-radius: var(--radius-md);
    text-align: center;
  }

  .feature-icon {
    font-size: 2.5rem;
    margin-bottom: var(--spacing-sm);
  }

  .feature-title {
    font-size: 1.25rem;
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
  }

  .feature-description {
    color: var(--color-text-secondary);
    font-size: 0.9375rem;
    line-height: 1.6;
  }

  .skills-container {
    padding: var(--spacing-xl) 0;
  }

  .skills-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--spacing-md);
    max-width: 1200px;
    margin-left: auto;
    margin-right: auto;
    padding: 0 var(--spacing-md);
  }

  .skills-header h2 {
    margin: 0;
  }

  .download-pack-btn {
    padding: var(--spacing-sm) var(--spacing-md);
    background: transparent;
    color: var(--color-text);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all 0.2s;
    font-size: 0.9375rem;
  }

  .download-pack-btn:hover {
    border-color: var(--color-primary);
    color: var(--color-primary);
  }

  /* æ¨¡æ€æ¡†æ ·å¼ */
  .modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 1000;
  }

  .modal-content {
    background: var(--color-white);
    border-radius: var(--radius-lg);
    max-width: 600px;
    width: 90%;
    max-height: 80vh;
    overflow-y: auto;
  }

  .modal-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--spacing-md);
    border-bottom: 1px solid var(--color-border);
  }

  .modal-header h2 {
    margin: 0;
    font-size: 1.5rem;
  }

  .modal-close {
    background: transparent;
    border: none;
    font-size: 1.5rem;
    cursor: pointer;
    color: var(--color-text-secondary);
  }

  .modal-body {
    padding: var(--spacing-md);
  }

  .modal-description {
    color: var(--color-text-secondary);
    margin-bottom: var(--spacing-md);
  }

  .pack-list {
    display: flex;
    flex-direction: column;
    gap: var(--spacing-sm);
  }

  .pack-button {
    padding: var(--spacing-md);
    background: var(--color-bg-secondary);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    text-align: left;
    cursor: pointer;
    transition: all 0.2s;
  }

  .pack-button:hover {
    border-color: var(--color-primary);
    background: var(--color-bg);
  }

  .pack-name {
    font-weight: 600;
    margin-bottom: var(--spacing-xs);
  }

  .pack-description {
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  /* æŠ€èƒ½è¯¦æƒ…æ¨¡æ€æ¡† */
  .skill-detail-name {
    font-size: 1.5rem;
    font-weight: 600;
    margin-bottom: var(--spacing-sm);
  }

  .skill-detail-meta {
    display: flex;
    gap: var(--spacing-md);
    margin-bottom: var(--spacing-md);
    font-size: 0.875rem;
    color: var(--color-text-secondary);
  }

  .skill-detail-triggers {
    margin-bottom: var(--spacing-md);
  }

  .skill-detail-triggers h4 {
    margin-bottom: var(--spacing-xs);
  }

  @media (max-width: 768px) {
    .skills-header {
      flex-direction: column;
      gap: var(--spacing-sm);
      text-align: center;
    }

    .features-grid {
      grid-template-columns: 1fr;
    }
  }
</style>

<script define:vars={{ skills }}>
  // æŠ€èƒ½æ•°æ®ï¼ˆä»æœåŠ¡å™¨ä¼ é€’ï¼‰
  const skillsData = skills;

  // ç›‘å¬åˆ†ç±»æŒ‰é’®ç‚¹å‡»
  document.addEventListener('click', (e) => {
    const target = e.target;
    const categoryButton = target.closest('.category-button');

    if (categoryButton) {
      const category = categoryButton.dataset.category;

      // æ›´æ–°æŒ‰é’®çŠ¶æ€
      document.querySelectorAll('.category-button').forEach(btn => {
        btn.classList.remove('active');
      });
      categoryButton.classList.add('active');

      // è¿‡æ»¤æŠ€èƒ½å¡ç‰‡
      document.querySelectorAll('.skill-card').forEach(card => {
        if (category === 'all' || card.dataset.category === category) {
          card.style.display = '';
        } else {
          card.style.display = 'none';
        }
      });
    }
  });

  // åˆ›å»ºæ¨¡æ€æ¡†å·¥å…·å‡½æ•°
  function createModal(config) {
    const modalHtml = `
      <div class="modal-overlay" id="${config.id}">
        <div class="modal-content">
          <div class="modal-header">
            <h2>${config.title}</h2>
            <button class="modal-close">&times;</button>
          </div>
          <div class="modal-body">${config.content}</div>
        </div>
      </div>
    `;

    document.body.insertAdjacentHTML('beforeend', modalHtml);

    const modal = document.getElementById(config.id);
    const closeBtn = modal?.querySelector('.modal-close');

    const close = () => {
      modal?.remove();
      config.onClose?.();
    };

    closeBtn?.addEventListener('click', close);
    modal?.addEventListener('click', (e) => {
      if (e.target === modal) close();
    });

    return { modal, close };
  }

  // å•ä¸ªä¸‹è½½åŠŸèƒ½
  document.addEventListener('click', async (e) => {
    const target = e.target;
    const downloadBtn = target.closest('.btn-download');

    if (downloadBtn) {
      const skillId = downloadBtn.dataset.skillId;
      const skill = skillsData.find(s => s.id === skillId);

      if (skill) {
        const { downloadSingleSkill } = await import('../utils/downloader');
        downloadSingleSkill(skill);

        const originalText = downloadBtn.textContent;
        downloadBtn.textContent = 'å·²ä¸‹è½½!';
        downloadBtn.style.background = 'var(--color-primary-hover)';

        setTimeout(() => {
          downloadBtn.textContent = originalText;
          downloadBtn.style.background = '';
        }, 2000);
      }
    }
  });

  // æŸ¥çœ‹è¯¦æƒ…åŠŸèƒ½
  document.addEventListener('click', (e) => {
    const target = e.target;
    const viewBtn = target.closest('.btn-view');

    if (viewBtn) {
      const skillName = viewBtn.dataset.skillName;
      const skillDescription = viewBtn.dataset.skillDescription;
      const skillTriggers = viewBtn.dataset.skillTriggers;

      createModal({
        id: 'skill-detail-modal',
        title: 'æŠ€èƒ½è¯¦æƒ…',
        content: `
          <div class="skill-detail-name">${skillName}</div>
          <p class="skill-detail-description">${skillDescription}</p>
          <div class="skill-detail-triggers">
            <h4>è§¦å‘è¯ï¼š</h4>
            <p>${skillTriggers}</p>
          </div>
        `
      });
    }
  });

  // æŠ€èƒ½åŒ…ä¸‹è½½åŠŸèƒ½
  const downloadPackBtn = document.getElementById('download-pack');
  if (downloadPackBtn) {
    downloadPackBtn.addEventListener('click', async () => {
      const { skillPacks, filterSkillsForPack, downloadSkillPack } = await import('../utils/packager');

      const packList = Object.entries(skillPacks).map(([key, pack]) => `
        <button class="pack-button" data-pack="${key}">
          <div class="pack-name">${pack.name}</div>
          <div class="pack-description">${pack.description}</div>
        </button>
      `).join('');

      const { modal, close } = createModal({
        id: 'pack-modal',
        title: 'ä¸‹è½½æŠ€èƒ½åŒ…',
        content: `
          <p class="modal-description">é€‰æ‹©è¦ä¸‹è½½çš„æŠ€èƒ½åŒ…ï¼š</p>
          <div class="pack-list">${packList}</div>
        `
      });

      modal?.querySelectorAll('.pack-button').forEach(button => {
        button.addEventListener('click', async () => {
          const packKey = button.dataset.pack;
          const filteredSkills = filterSkillsForPack(skillsData, packKey);
          const packName = button.querySelector('.pack-name')?.textContent || 'skills';

          await downloadSkillPack(
            filteredSkills.map(s => ({
              id: s.id,
              name: s.name,
              content: s.content
            })),
            packName
          );

          close();
        });
      });
    });
  }
</script>
